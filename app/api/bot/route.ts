import { Bot, webhookCallback, InlineKeyboard, Keyboard } from "grammy";

export const dynamic = 'force-dynamic';

const token = process.env.TELEGRAM_BOT_TOKEN;
if (!token) throw new Error("TELEGRAM_BOT_TOKEN is unset");

const bot = new Bot(token);

// --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù…ØªÙˆØ³Ø· Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³ÙˆÙ‚ Ù„Ù„Ø­Ø§Ø³Ø¨Ø©) ---
const RATES: Record<string, number> = {
    'Ø§Ù„Ø°Ù‡Ø¨ (Gold)': 4.0,
    'ÙŠÙˆØ±Ùˆ Ø¯ÙˆÙ„Ø§Ø± (EURUSD)': 2.5,
    'Ø¨Ø§ÙˆÙ†Ø¯ Ø¯ÙˆÙ„Ø§Ø± (GBPUSD)': 3.0,
    'Ø¯Ø§Ùˆ Ø¬ÙˆÙ†Ø² (US30)': 1.5,
    'Ù†Ø§Ø³Ø¯Ø§Ùƒ (NASDAQ)': 1.5,
    'Ø§Ù„Ù†ÙØ· (OIL)': 3.0
};

// --- Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…) ---

// 1. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ø«Ø§Ø¨ØªØ©
const mainMenu = new Keyboard()
    .text("ğŸ’° Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ÙƒØ§Ø´ Ø¨Ø§Ùƒ").text("ğŸ§® Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªÙˆÙÙŠØ±").row()
    .text("ğŸ¦ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ³Ø·Ø§Ø¡").text("âš–ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©").row()
    .text("ğŸ“ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ").resized();

// 2. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
const actionMenu = new InlineKeyboard()
    .url("ğŸŒ ØªØµÙØ­ Ø§Ù„ÙˆØ³Ø·Ø§Ø¡", "https://www.bksheesh.com/brokers")
    .url("ğŸ‘¤ ÙØªØ­ Ø­Ø³Ø§Ø¨ ÙƒØ§Ø´ Ø¨Ø§Ùƒ", "https://www.bksheesh.com/register");

// --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ ---

// 1. Ø£Ù…Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© /start
bot.command("start", async (ctx) => {
    await ctx.reply(
        "ğŸ‘‹ **Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Backsheesh**\n\n" +
        "Ù†Ø­Ù† Ù†Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„ÙŠÙ† Ø¹Ù„Ù‰ ØªØ­Ø³ÙŠÙ† Ø±Ø¨Ø­ÙŠØªÙ‡Ù… Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¬Ø²Ø¡ Ù…Ù† ÙØ±ÙˆÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø± (Ø§Ù„Ø³Ø¨Ø±ÙŠØ¯) ÙˆØ§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª.\n\n" +
        "ğŸ”¹ **Ø£Ø¯Ø§Ø© Ø¹Ù…Ù„ÙŠØ©:** Ø§Ø­Ø³Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© ÙÙˆØ±Ø§Ù‹.\n" +
        "ğŸ”¹ **Ø´ÙØ§ÙÙŠØ© ØªØ§Ù…Ø©:** ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù†Ø³Ø¨ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù„ÙƒÙ„ ÙˆØ³ÙŠØ·.\n" +
        "ğŸ”¹ **Ù†Ø¸Ø§Ù… Ø¢Ù„ÙŠ:** Ù…Ø¯ÙÙˆØ¹Ø§Øª (ÙŠÙˆÙ…ÙŠØ©/Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©) Ù„Ù…Ø­ÙØ¸ØªÙƒ.\n\n" +
        "ğŸ‘‡ *Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„ØªÙ†Ù‚Ù„:*",
        { 
            parse_mode: "Markdown", 
            reply_markup: mainMenu 
        }
    );
});

// 2. Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± (Ù„Ù„Ø­Ø§Ø³Ø¨Ø©)
bot.hears(["ğŸ’° Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ÙƒØ§Ø´ Ø¨Ø§Ùƒ", "/rates"], async (ctx) => {
    let msg = "ğŸ“Š **Ù…ØªÙˆØ³Ø· Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ (Ù„ÙƒÙ„ 1 Ù„ÙˆØª):**\n\n";
    for (const [key, val] of Object.entries(RATES)) {
        msg += `â€¢ ${key}:  **~$${val}**\n`;
    }
    msg += "\n*ØªØ®ØªÙ„Ù Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø­Ø³Ø¨ Ø§Ù„ÙˆØ³ÙŠØ· Ø§Ù„Ù…Ø®ØªØ§Ø± ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨.*";
    
    await ctx.reply(msg, { parse_mode: "Markdown" });
});

// 3. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ³Ø·Ø§Ø¡ (ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ)
bot.hears(["ğŸ¦ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ³Ø·Ø§Ø¡", "/brokers"], async (ctx) => {
    await ctx.reply(
        "ğŸ¦ **Ø´Ø±ÙƒØ§Ø¡ Ø§Ù„Ù†Ø¬Ø§Ø­ (Ø§Ù„ÙˆØ³Ø·Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…ÙŠÙ†)**\n\n" +
        "Ø§Ø®ØªØ± ÙˆØ³ÙŠØ·Ùƒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒØ§Ø´ Ø¨Ø§Ùƒ Ø¹Ù„Ù‰ ÙƒÙ„ ØµÙÙ‚Ø©. Ø¥Ù„ÙŠÙƒ Ø£Ø¨Ø±Ø² Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:\n\n" +
        "ğŸ”¥ **Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¹Ø§Ø¦Ø¯Ø§Ù‹:**\n" +
        "â€¢ **FXTM:** Ø§Ø³ØªØ±Ø¯Ø§Ø¯ **$15.00** / Ù„ÙˆØª (Ø£Ø³Ø¨ÙˆØ¹ÙŠ)\n" +
        "â€¢ **Valetax:** Ø§Ø³ØªØ±Ø¯Ø§Ø¯ **$10.00** / Ù„ÙˆØª (ÙŠÙˆÙ…ÙŠ)\n" +
        "â€¢ **INFINOX:** Ø§Ø³ØªØ±Ø¯Ø§Ø¯ **$6.00** / Ù„ÙˆØª (Ø£Ø³Ø¨ÙˆØ¹ÙŠ)\n\n" +
        "âœ… **ÙˆØ³Ø·Ø§Ø¡ Ù…Ø¹ØªÙ…Ø¯ÙˆÙ† Ø£ÙŠØ¶Ø§Ù‹:**\n" +
        "â€¢ OneRoyal\n" +
        "â€¢ HeadWay\n" +
        "â€¢ Monaxa\n" +
        "â€¢ Litefinance\n" +
        "â€¢ TOPFX\n\n" +
        "Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ ÙƒÙ„ ÙˆØ³ÙŠØ· ÙˆÙØªØ­ Ø­Ø³Ø§Ø¨ØŒ Ø§Ø¶ØºØ· Ø¨Ø§Ù„Ø£Ø³ÙÙ„:",
        { reply_markup: actionMenu }
    );
});

// 4. Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©
bot.hears(["âš–ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©", "/legal"], async (ctx) => {
    await ctx.reply(
        "âš–ï¸ **Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© ÙˆØ§Ù„Ø§Ù…ØªØ«Ø§Ù„**\n\n" +
        "**Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø®Ø¯Ù…Ø©:** Backsheesh Ù‡ÙŠ Ø®Ø¯Ù…Ø© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¹Ù…ÙˆÙ„Ø§Øª (IB Rebate). Ù†Ø­Ù† Ù„Ø§ Ù†Ù‚Ø¯Ù… Ù†ØµØ§Ø¦Ø­ Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© ÙˆÙ„Ø§ Ù†Ø¯ÙŠØ± Ù…Ø­Ø§ÙØ¸ Ù…Ø§Ù„ÙŠØ©.\n\n" +
        "**ØªØ­Ø°ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ø·Ø±:** ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ÙÙˆØ±ÙƒØ³ ÙˆØ§Ù„ÙƒØ±ÙŠØ¨ØªÙˆ ÙŠÙ†Ø·ÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø®Ø§Ø·Ø± Ø¹Ø§Ù„ÙŠØ©. Ø®Ø¯Ù…Ø© Ø§Ù„ÙƒØ§Ø´ Ø¨Ø§Ùƒ ØªÙ‚Ù„Ù„ Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆÙ„Ø§ ØªØ¶Ù…Ù† Ø§Ù„Ø±Ø¨Ø­.\n\n" +
        "**Ø§Ù„Ø®ØµÙˆØµÙŠØ©:** Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¯Ø§ÙˆÙ„Ùƒ Ù…Ø´ÙØ±Ø© ÙˆÙ„Ø§ ÙŠØªÙ… Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§.",
        { parse_mode: "Markdown" }
    );
});

// 5. Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ
bot.hears(["ğŸ“ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ", "/help"], async (ctx) => {
    await ctx.reply(
        "ğŸ“ **Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø¹Ù…**\n\n" +
        "Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ³ÙŠØ· Ø§Ù„Ø£Ù†Ø³Ø¨ØŸ\n\n" +
        "ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: support@bksheesh.com\n" +
        "ğŸ¤– Ø§Ù„Ø­Ø§Ù„Ø©: **Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ù„Ù„Ø®Ø¯Ù…Ø©**",
        { parse_mode: "Markdown" }
    );
});

// 6. Ø§Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø©
bot.hears(["ğŸ§® Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªÙˆÙÙŠØ±", "/calc"], async (ctx) => {
    const keyboard = new InlineKeyboard();
    Object.keys(RATES).forEach(pair => {
        keyboard.text(pair, `calc_pair_${pair}`).row(); 
    });
    
    await ctx.reply("ğŸ§® **Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø°ÙƒÙŠØ©**\nØ§Ø®ØªØ± Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø°ÙŠ ØªØªØ¯Ø§ÙˆÙ„Ù‡ Ù„ØªÙ‚Ø¯ÙŠØ± Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯:", {
        reply_markup: keyboard
    });
});

// --- Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© ---
bot.callbackQuery(/^calc_pair_(.+)$/, async (ctx) => {
    const pair = ctx.match[1]; 
    const keyboard = new InlineKeyboard()
        .text("1 Ù„ÙˆØª / ÙŠÙˆÙ…ÙŠØ§Ù‹", `calc_res_${pair}_1`)
        .text("5 Ù„ÙˆØª / ÙŠÙˆÙ…ÙŠØ§Ù‹", `calc_res_${pair}_5`)
        .text("10 Ù„ÙˆØª / ÙŠÙˆÙ…ÙŠØ§Ù‹", `calc_res_${pair}_10`);

    await ctx.editMessageText(`ğŸ“‰ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: **${pair}**\nÙƒÙ… Ø­Ø¬Ù… ØªØ¯Ø§ÙˆÙ„Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ØŸ`, {
        parse_mode: "Markdown", 
        reply_markup: keyboard
    });
});

bot.callbackQuery(/^calc_res_(.+)_(.+)$/, async (ctx) => {
    const pair = ctx.match[1];
    const lots = parseInt(ctx.match[2]);
    const rate = RATES[pair] || 4.0;
    const daily = lots * rate;
    const monthly = daily * 22;

    await ctx.editMessageText(
        `ğŸ“Š **ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©**\n\n` +
        `Ø§Ù„Ø±Ù…Ø²: ${pair}\nØ§Ù„Ø­Ø¬Ù…: ${lots} Ù„ÙˆØª/ÙŠÙˆÙ…ÙŠØ§Ù‹\n\n` +
        `ğŸ’° **Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ:** $${daily}\n` +
        `ğŸ—“ï¸ **Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ:** $${monthly}\n\n` +
        `_Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù„Øº ÙŠÙ…Ø«Ù„ ØªÙˆÙÙŠØ±Ø§Ù‹ Ù…Ø­ØªÙ…Ù„Ø§Ù‹ ÙŠØ¹ÙˆØ¯ Ù„Ù…Ø­ÙØ¸ØªÙƒ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¯ÙØ¹Ù‡ ÙƒØ¹Ù…ÙˆÙ„Ø©._`,
        { 
            parse_mode: "Markdown",
            reply_markup: actionMenu 
        }
    );
});

// Ø§Ù„Ø±Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
bot.on("message", (ctx) => ctx.reply("ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„ØªÙ†Ù‚Ù„.", { reply_markup: mainMenu }));

export const POST = webhookCallback(bot, "std/http");
    
    await ctx.reply("ğŸ§® **Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø°ÙƒÙŠØ©**\nØ§Ø®ØªØ± Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø°ÙŠ ØªØªØ¯Ø§ÙˆÙ„Ù‡ Ù„ØªÙ‚Ø¯ÙŠØ± Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯:", {
        reply_markup: keyboard
    });
});

// --- Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© ---
bot.callbackQuery(/^calc_pair_(.+)$/, async (ctx) => {
    const pair = ctx.match[1]; 
    const keyboard = new InlineKeyboard()
        .text("1 Ù„ÙˆØª / ÙŠÙˆÙ…ÙŠØ§Ù‹", `calc_res_${pair}_1`)
        .text("5 Ù„ÙˆØª / ÙŠÙˆÙ…ÙŠØ§Ù‹", `calc_res_${pair}_5`)
        .text("10 Ù„ÙˆØª / ÙŠÙˆÙ…ÙŠØ§Ù‹", `calc_res_${pair}_10`);

    await ctx.editMessageText(`ğŸ“‰ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: **${pair}**\nÙƒÙ… Ø­Ø¬Ù… ØªØ¯Ø§ÙˆÙ„Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ØŸ`, {
        parse_mode: "Markdown", 
        reply_markup: keyboard
    });
});

bot.callbackQuery(/^calc_res_(.+)_(.+)$/, async (ctx) => {
    const pair = ctx.match[1];
    const lots = parseInt(ctx.match[2]);
    
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø¹Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… (Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¬Ø²Ø¦ÙŠØ© Ø¨Ø³ÙŠØ·Ø©)
    const rate = RATES[pair] || 4.0; // Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
    
    const daily = lots * rate;
    const monthly = daily * 22;

    await ctx.editMessageText(
        `ğŸ“Š **ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©**\n\n` +
        `Ø§Ù„Ø±Ù…Ø²: ${pair}\nØ§Ù„Ø­Ø¬Ù…: ${lots} Ù„ÙˆØª/ÙŠÙˆÙ…ÙŠØ§Ù‹\n\n` +
        `ğŸ’° **Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ:** $${daily}\n` +
        `ğŸ—“ï¸ **Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ:** $${monthly}\n\n` +
        `_Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØªÙ… Ø¯ÙØ¹Ù‡ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù„ÙˆØ³ÙŠØ· ÙƒØ¹Ù…ÙˆÙ„Ø©. Ø§Ù†Ø¶Ù… Ø¥Ù„ÙŠÙ†Ø§ Ù„Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ ÙÙŠ Ù…Ø­ÙØ¸ØªÙƒ._`,
        { 
            parse_mode: "Markdown",
            reply_markup: actionMenu 
        }
    );
});

// Ø§Ù„Ø±Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
bot.on("message", (ctx) => ctx.reply("ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„ØªÙ†Ù‚Ù„.", { reply_markup: mainMenu }));

export const POST = webhookCallback(bot, "std/http");
        .url("ğŸ”— Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯", "https://www.bksheesh.com/register")
        .row()
        .text("ğŸ”™ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", "menu_main");

    await ctx.editMessageText(msg, { parse_mode: "Markdown", reply_markup: keyboard });
});

// --- D. BACK TO MAIN MENU ---
bot.callbackQuery("menu_main", async (ctx) => {
    const keyboard = new InlineKeyboard()
        .text("ğŸ’¸ ÙƒÙ… Ø³Ø£Ø³ØªØ±Ø¬Ø¹ØŸ (Ø§Ù„Ø£Ø³Ø¹Ø§Ø±)", "menu_rates").row()
        .text("ğŸ§® Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø°ÙƒÙŠØ©", "calc_start").row()
        .url("ğŸ”— Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ÙŠ ÙÙˆØ±Ø§Ù‹", "https://www.bksheesh.com/register");
        
    await ctx.editMessageText(
        "**ÙŠØ§ Ù‡Ù„Ø§.. Ø®Ù„Ù†Ø§ Ù†ÙƒÙˆÙ† ÙˆØ§Ø¶Ø­ÙŠÙ†.** ğŸ¤\n\n" +
        "Ø§Ø®ØªØ± Ø®Ø¯Ù…ØªÙƒ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„:",
        { parse_mode: "Markdown", reply_markup: keyboard }
    );
});

// --- E. VERCEL CONNECTION ---
export const POST = webhookCallback(bot, "std/http");
